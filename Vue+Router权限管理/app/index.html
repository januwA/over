<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9"><![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<html lang="zh-cmn-Hans">

<head>
    <meta charset="utf-8">
    <title>ajanuw</title>
    <link rel="shortcut icon" type="image/ico" href="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--移动端视图-->
    <meta name="renderer" content="webkit" />
    <meta name="keywords" content="ajanuw" />
    <!--关键词-->
    <meta name="description" content="ajanuw, b,c" />
    <!--网站内容描述-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="Pragma" content="no-cache" />
    <!--禁止浏览器从本地计算机的缓存中访问页面内容-->
    <meta http-equiv="Window-target" content="_top" />
    <!--强制页面在当前窗口以独立页面显示-->
    <meta http-equiv="content-Type" content="text/html;charset=utf-8" />
    <!--显示字符集的设定-->
    <meta http-equiv="Content-Language" content="zh-cn" />
    <!--显示语言的设定-->
    <meta http-equiv="imagetoolbar" content="false" />
    <!--指定是否显示图片工具栏，false不显示,true显示-->
    <meta name="theme-color" content="#ff4081" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <!-- Chrome, Firefox OS and Opera -->
</head>

<body>
    <!--[if lt IE 8]>  <h3>请升级你的浏览器，或更换主浏览器！！!</h3>  <![endif]-->
    <div id="app">
        <router-view></router-view>
    </div>

    <template id="home">
        <div>{{ body }}</div>
    </template>
    <template id="login">
        <section>
            <input v-model.trim="name" placeholder="name">
            <br>
            <input v-model.trim="password" placeholder="password">
            <br>
            <button @click="submit">Submit</button>
            <br>
        </section>
    </template>
    <script src="https://cdn.bootcss.com/vue/2.4.4/vue.js"></script>
    <script src="https://cdn.bootcss.com/vue-router/2.7.0/vue-router.min.js"></script>
    <script src="https://cdn.bootcss.com/lodash.js/4.17.4/lodash.js"></script>
    <script src="https://cdn.bootcss.com/rxjs/6.1.0/rxjs.umd.js"></script>
    <script>
        // this.$router 访问路由器
        // this.$route 访问当前路由
        const Home = {
            data() {
                return {
                    body: ''
                }
            },
            created() {
                const token = sessionStorage.getItem('token')
                fetch(`/getData?token=${+token}&t=${+new Date()}`, {
                        method: 'GET',
                        headers: {
                            'content-type': 'application/json'
                        }
                    }).then(res => res.json())
                    .then(res => {
                        console.log(res);
                        if (res.code === 0) {
                            // 登陆时间过期
                            console.log('登陆时间过期');
                            sessionStorage.setItem('token', null)
                            return this.$router.push('/login');
                        }

                        if (res.code === 1) {
                            this.body = res.body
                        }
                    })

            },
            template: '#home'
        }

        const Login = {
            data() {
                return {
                    name: '',
                    password: ''
                }
            },
            methods: {
                submit() {
                    rxjs.of({
                        name: this.name,
                        password: this.password
                    }).pipe(
                        rxjs.operators.filter(v => !_.eq(v.name, '') && !_.eq(v.password, '') && v.password.length >
                            3)
                    ).subscribe(
                        v => {
                            fetch('/login', {
                                    method: 'POST',
                                    body: jsonToSerialize(v),
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8'
                                    }
                                }).then(res => res.json())
                                .then(res => {
                                    if (_.eq(res.code, 0)) {
                                        console.log('用户名不存在');
                                        return false;
                                    } else if (_.eq(res.code, 1)) {
                                        sessionStorage.setItem('token', `${res.token}`);
                                        this.$router.push({
                                            path: '/'
                                        })
                                    } else {
                                        console.log('未知错误!');
                                    }
                                })

                        }
                    );

                }
            },
            template: '#login'
        }
        const NotFound = {
            template: '<div> 404 </div>'
        }
        const routes = [{
                path: '/',
                redirect: '/home'
            },
            {
                path: '/login',
                component: Login
            },
            {
                path: '/home',
                component: Home
            },
            {
                path: '*',
                component: NotFound
            },
        ]

        const router = new VueRouter({
            routes
        })


        router.beforeEach((to, from, next) => {
            // 这个路由守卫只用来判断是否在登录状态

            if (_.includes(to.path, 'home')) {
                const token = sessionStorage.getItem('token');
                if (token) {
                    next()
                } else {
                    next('/login')
                }
            } else {
                next()
            }
        })

        const vm_vue = new Vue({
            router,
            data() {
                return {
                    msg: 'hello'
                }
            }
        }).$mount('#app')


        function jsonToSerialize(obj) {
            /**
             把json转化成序列化字符串
             console.log(jsonToSerialize({name:'ajanuw',age:23}));
             name=ajanuw&age=23
            */
            let s = '';
            for (let el in obj) {
                s += `${el}=${obj[el]}&`
            }
            return s.replace(/&$/, '');
        }
    </script>
</body>

</html>